<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CAVOC - Tutoriel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="win.css" />
    <link rel="stylesheet" href="option_window.css">
    <link rel="shortcut icon" href="./" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      #tuto-badge {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 2000; /* Au-dessus de tout */
        background: rgba(39, 40, 34, 0.8); /* Fond sombre semi-transparent */
        padding: 8px 12px;
        border-radius: 4px;
        border-left: 4px solid #a6e22e; /* Touche de vert Monokai */
        color: #f8f8f2;
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }

      .tuto-title {
        font-weight: bold;
        color: #a6e22e;
      }

      #end-tuto-btn {
        background-color: #a6e22e;
        color: #272822;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-weight: bold;
        font-family: inherit;
        font-size: 12px;
        text-transform: uppercase;
        transition: background 0.3s;
        display: none; /* Cach√© par d√©faut */
      }

      #end-tuto-btn:hover {
        background-color: #32b568;
      }
    </style>
  </head>

  <body>
    <div id="tuto-badge">
      <span class="tuto-title">üéì TUTORIEL</span>
      <span id="tuto-status" style="font-size: 12px; opacity: 0.8;">En cours...</span>
      <a href="index.html" style="text-decoration:none;">
        <button id="end-tuto-btn">Acc√©der au jeu &rarr;</button>
      </a>
    </div>

    <div class="container code-section">
      <h2>Code OCaml</h2>
      <div id="editor"></div>
    </div>

    <div class="container signature">
      <h2>Signature OCaml</h2>
      <div id="signatureEditor"></div>
    </div>
    <div id="help" class="help">
      <button id="help-btn" class="help-btn">Help</button>
    </div>
    
    <div id="help-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div id="markdown-content">Chargement...</div>
      </div>
    </div>

    <div id="file-selection" class="file-selection-container">
      <label for="file-select">Select a file:</label>
      <select id="file-select-dropdown" class="file-select">
        </select>
      <button id="load-btn" class="load-btn">Load</button>
    </div>

    <div id="output-container">
      <div id="select-move">
        <div id="moves-list">
          </div>
      </div>
      <div id="histo-config-container">
        <div class="tabs">
          <div class="tab-nav">
            <button class="tab-link active" onclick="openTab(event, 'config')">
              Configuration
            </button>
            <button class="tab-link" onclick="openTab(event, 'ienv')">
              ienv
            </button>
            <button class="tab-link" onclick="openTab(event, 'store')">
              Store
            </button>
            <button class="tab-link" onclick="openTab(event, 'histo')">
              History
            </button>
            <button class="tab-link" onclick="openTab(event, 'console')">
              Console
            </button>
          </div>

          <div id="config" class="tab-content active"></div>
          <div id="ienv" class="tab-content">
            <div id="ienv-div" class="tab-content active"></div>
            <div id="stack-container" class="tab-content active"></div>
          </div>
          <div id="store" class="tab-content"></div>
          <div id="histo" class="tab-content">
            <div id="history"></div>
          </div>
          <div id="console" class="tab-content"></div>
        </div>
      </div>
    </div>
    <div id="buttons-container">
      <button id="select-btn">Select</button>
      <button id="stop-btn">Stop</button>
      <div id="center-controls">
  
        <div class="options-dropdown-container">
          <button id="options-btn" class="options-btn">Options ‚öôÔ∏è</button>
          <div id="options-menu" class="options-menu-content">
            <div class="option-item">
              <input type="checkbox" id="direct-style-check">
              <label for="direct-style-check">Direct Style</label>
            </div>
            <hr style="border: 0; border-top: 1px solid #555; margin: 5px 0;">
            <div class="option-item">
              <input type="checkbox" id="wellbracketing-check">
              <label for="wellbracketing-check">WellBracketing</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="visibility-check">
              <label for="visibility-check">Visibility</label>
            </div>
          </div>
        </div>

        <button id="submit">Evaluate</button>
      </div>
    </div>
    
    <script src="../_build/default/bin/explore_web.bc.js"></script>
  </body>

  <script>
    // Initialize ACE editor
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/ocaml");
    var signatureEditor = ace.edit("signatureEditor");
    signatureEditor.setTheme("ace/theme/monokai");
    signatureEditor.session.setMode("ace/mode/ocaml");
    
    // Store editor instances in global variables
    window.editor_instance = editor;
    window.signatureEditor_instance = signatureEditor;

    var configEditor = ace.edit("config");
    configEditor.setTheme("ace/theme/monokai");
    configEditor.session.setMode("ace/mode/ocaml");
    configEditor.setReadOnly(true);
    configEditor.renderer.$cursorLayer.element.style.display = "none";
    window.configEditor_instance = configEditor;

    // Config tabs logic
    function openTab(event, tabId) {
      const contents = document.querySelectorAll(".tab-content");
      contents.forEach((content) => content.classList.remove("active"));
      const links = document.querySelectorAll(".tab-link");
      links.forEach((link) => link.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      event.currentTarget.classList.add("active");
    }
  </script>
  
  <script>
    window.onload = async function () {
      
      // --- LOGIQUE DE SUIVI DU TUTO ---
      setInterval(() => {
        if (localStorage.getItem("tuto_completed") === "true") {
            const btn = document.getElementById("end-tuto-btn");
            const status = document.getElementById("tuto-status");
            
            if(btn && btn.style.display !== "block") {
                btn.style.display = "block"; // Affiche le bouton
                status.innerText = "Termin√© !";
                status.style.color = "#a6e22e";
                status.style.fontWeight = "bold";
                
                // Animation visuelle optionnelle sur le badge
                document.getElementById("tuto-badge").style.boxShadow = "0 0 15px rgba(166, 226, 46, 0.5)";
            }
        }
      }, 1000);

      // --- CHARGEMENT DES FICHIERS TUTO ---
      let filesList = [];
      try {
        // Demande sp√©cifique pour le dossier 'tuto'
        const response = await fetch('http://localhost:8000/list_files?dir=tuto');
        filesList = await response.json();
      } catch(e){
        console.log("Erreur chargement liste tuto:", e);
      }

      const mlFiles = filesList.filter((file) => file.endsWith(".ml"));
      const fileSelect = document.getElementById("file-select-dropdown");
      mlFiles.forEach((file) => {
        const option = document.createElement("option");
        option.value = file;
        option.text = file;
        fileSelect.appendChild(option);
      });

      if(mlFiles.length > 0) fileSelect.value = mlFiles[0];

      // Bouton LOAD pour les tutos
      document.getElementById("load-btn").addEventListener("click", function () {
          const selectedFileName = document.getElementById("file-select-dropdown").value;
          if (selectedFileName) {
            const mlFileName = selectedFileName;
            const mliFileName = mlFileName.replace(".ml", ".mli");

            // Chemins pointant vers ../tuto/
            fetch(`../tuto/${mlFileName}`)
              .then((r) => r.text()).then((c) => editor.session.setValue(c))
              .catch((e) => console.error("Error loading .ml:", e));

            fetch(`../tuto/${mliFileName}`)
              .then((r) => r.text()).then((c) => signatureEditor.session.setValue(c))
              .catch(() => signatureEditor.session.setValue(""));
          }
      });
      
      // Chargement initial
      if(mlFiles.length > 0) document.getElementById("load-btn").click();
    };

    // Gestion du menu Options
    document.getElementById('options-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        const menu = document.getElementById('options-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    // Fermer le menu si on clique ailleurs
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('options-menu');
        const btn = document.getElementById('options-btn');
        if (menu.style.display === 'block' && !menu.contains(e.target) && e.target !== btn) {
            menu.style.display = 'none';
        }
    });
  </script>
</html>