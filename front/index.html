<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CAVOC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="win.css">
    <link rel="shortcut icon" href="./" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>

  <body>
    <div class="container code-section">
      <h2>Code OCaml</h2>
      <div id="editor"></div>
    </div>

    <div class="container signature">
      <h2>Signature OCaml</h2>
      <div id="signatureEditor"></div>
    </div>
    <div id="help" class="help">
      <button id="help-btn" class="help-btn">Help</button>
    </div>
    <div id="help-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div id="markdown-content">Chargement...</div>
    </div>
    </div>

    <div id="file-selection" class="file-selection-container">
      <label for="file-select">Select a file:</label>
      <select id="file-select-dropdown" class="file-select">
        </select>
      <button id="load-btn" class="load-btn">Load</button>

      <span class="style-toggle">
        <input type="checkbox" id="direct-style-check" name="direct-style">
        <label for="direct-style-check" title="Activer le mode DirectStyle">Direct Style</label>
      </span>
    </div>
    <div id="output-container">
      <div id="select-move">
        <div id="moves-list">
          </div>
      </div>
      <div id="histo-config-container">
        <div class="tabs">
          <div class="tab-nav">
            <button class="tab-link active" onclick="openTab(event, 'config')">
              Configuration
            </button>
            <button class="tab-link" onclick="openTab(event, 'ienv')">
              ienv
            </button>
            <button class="tab-link" onclick="openTab(event, 'store')">
              Store
            </button>
            <button class="tab-link" onclick="openTab(event, 'histo')">
              History
            </button>
            <button class="tab-link" onclick="openTab(event, 'console')">
              Console
            </button>
          </div>

          <div id="config" class="tab-content active"></div>
          <div id="ienv" class="tab-content">
            <div id="ienv-div" class="tab-content active"></div>
            <div id="stack-container" class="tab-content active"></div>
          </div>
          <div id="store" class="tab-content"></div>
          <div id="histo" class="tab-content">
            <div id="history"></div>
          </div>
          <div id="console" class="tab-content"></div>
        </div>
      </div>
    </div>
    <div id="buttons-container">
      <button id="select-btn">Select</button>
      <button id="stop-btn">Stop</button>
      <button id="submit">Evaluate</button>
    </div>
    <script src="../_build/default/bin/explore_web.bc.js"></script>
  </body>

  <script>
    // Initialize ACE editor
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/ocaml");
    var signatureEditor = ace.edit("signatureEditor");
    signatureEditor.setTheme("ace/theme/monokai");
    signatureEditor.session.setMode("ace/mode/ocaml");
    
    // Store editor instances in global variables to be accessed from OCaml
    window.editor_instance = editor;
    window.signatureEditor_instance = signatureEditor;

    var configEditor = ace.edit("config");
    configEditor.setTheme("ace/theme/monokai");
    configEditor.session.setMode("ace/mode/ocaml");
    configEditor.setReadOnly(true);
    configEditor.renderer.$cursorLayer.element.style.display = "none";
    window.configEditor_instance = configEditor;

    //script for config tabs
    function openTab(event, tabId) {
      // Hide all tab contents
      const contents = document.querySelectorAll(".tab-content");
      contents.forEach((content) => content.classList.remove("active"));

      // Remove "active" class from all tab links
      const links = document.querySelectorAll(".tab-link");
      links.forEach((link) => link.classList.remove("active"));

      // Show the selected tab content
      document.getElementById(tabId).classList.add("active");

      // Add "active" class to the clicked tab link
      event.currentTarget.classList.add("active");
    }
  </script>
  
  <script>
    window.onload = async function () {
      
      // --- LOGIQUE DE PROTECTION ---
      // Vérifie si le joueur a terminé le tutoriel
      const tutoComplete = localStorage.getItem("tuto_completed");
      
      if (tutoComplete !== "true") {
          // Si le tuto n'est pas fini, on redirige vers la page de tutoriel
          window.location.href = "indextuto.html";
          return; // On arrête l'exécution du script ici
      }
      
      // --- LOGIQUE DE JEU (DOSSIER TEST) ---
      
      // Ajout d'un bouton pour réinitialiser le jeu (utile pour le debug/démo)
      const body = document.querySelector("body");
      const resetBtn = document.createElement("button");
      resetBtn.innerText = "Reset Tuto";
      resetBtn.className = "help-btn"; 
      resetBtn.style.position = "absolute";
      resetBtn.style.top = "10px";
      resetBtn.style.left = "10px";
      resetBtn.onclick = function() {
          if(confirm("Voulez-vous vraiment réinitialiser votre progression et retourner au tutoriel ?")) {
            localStorage.removeItem("tuto_completed");
            window.location.reload();
          }
      };
      body.appendChild(resetBtn);

      let filesList = [];
      try {
        // On demande au serveur de lister les fichiers du dossier TEST
        const response = await fetch('http://localhost:8000/list_files?dir=test');
        filesList = await response.json();
      }
      catch(e){
        console.log("Erreur lors du chargement de la liste des fichiers:", e);
      }

      // Filter the list to get only the .ml files
      const mlFiles = filesList.filter((file) => file.endsWith(".ml"));

      // Populate the dropdown with the .ml file names
      const fileSelect = document.getElementById("file-select-dropdown");
      mlFiles.forEach((file) => {
        const option = document.createElement("option");
        option.value = file;
        option.text = file;
        fileSelect.appendChild(option);
      });

      // Set default file if available
      if(mlFiles.length > 0) fileSelect.value = mlFiles[0];

      // Load button listener
      document
        .getElementById("load-btn")
        .addEventListener("click", function () {
          const selectedFileName = document.getElementById("file-select-dropdown").value;
          
          if (selectedFileName) {
            const mlFileName = selectedFileName;
            const mliFileName = mlFileName.replace(".ml", ".mli");

            // Load .ml file content from TEST directory
            fetch(`../test/${mlFileName}`)
              .then((response) => response.text())
              .then((mlContent) => {
                editor.session.setValue(mlContent);
              })
              .catch((error) => console.error("Error loading .ml file:", error));

            // Load .mli file content from TEST directory
            fetch(`../test/${mliFileName}`)
              .then((response) => response.text())
              .then((mliContent) => {
                signatureEditor.session.setValue(mliContent);
              })
              .catch((error) => {
                console.error("Error loading .mli file:", error);
                signatureEditor.session.setValue("");
              });
          }
        });
        
      // Trigger initial load
      if(mlFiles.length > 0) {
          document.getElementById("load-btn").click();
      }
    };
  </script>
</html>